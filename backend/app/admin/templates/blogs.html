<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Blog Management - eCommerce Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="flex">
        <div class="hidden md:flex md:w-64 md:flex-col">
            <div class="flex flex-col h-0 flex-1 border-r border-gray-200 bg-white">
                <div class="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
                    <div class="flex items-center flex-shrink-0 px-4">
                        <span class="text-2xl font-bold text-primary-600">eCommerce Admin</span>
                    </div>
                    <nav class="mt-5 flex-1 px-2 space-y-1 bg-white">
                        <a href="/admin" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-tachometer-alt mr-3 text-gray-400 group-hover:text-gray-500"></i>
                            Dashboard
                        </a>
                        <a href="/admin/products" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-boxes mr-3 text-gray-400 group-hover:text-gray-500"></i>
                            Products
                        </a>
                        <a href="/admin/users" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-users mr-3 text-gray-400 group-hover:text-gray-500"></i>
                            Users
                        </a>
                        <a href="/admin/orders" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-shopping-cart mr-3 text-gray-400 group-hover:text-gray-500"></i>
                            Orders
                        </a>
                        <a href="/admin/offers" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-tag mr-3 text-gray-400 group-hover:text-gray-500"></i>
                            Offers
                        </a>
                        <a href="/admin/blogs" class="bg-primary-50 text-primary-600 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-newspaper mr-3 text-primary-500"></i>
                            Blogs
                        </a>
                        <a href="/admin/logout" class="text-red-600 hover:bg-red-50 hover:text-red-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i class="fas fa-sign-out-alt mr-3 text-red-400 group-hover:text-red-500"></i>
                            Logout
                        </a>
                    </nav>
                </div>
                <div class="flex-shrink-0 flex border-t border-gray-200 p-4">
                    <div class="flex items-center">
                        <div>
                            <div class="text-base font-medium text-gray-800">Admin User</div>
                            <div class="text-sm font-medium text-gray-500">admin@example.com</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm">
                <div class="px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <h1 class="text-2xl font-semibold text-gray-900">Blog Management</h1>
                    <div class="flex items-center space-x-4">
                        <img class="h-8 w-8 rounded-full" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="">
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <!-- Blog Form Card -->
                <div class="bg-white shadow rounded-lg mb-8">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 id="formTitle" class="text-lg leading-6 font-medium text-gray-900">Create New Blog</h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <form id="blogForm" class="space-y-5" novalidate>
                            <input type="hidden" id="blogId" />

                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700">Blog Title</label>
                                <input type="text" id="title" name="title" required aria-required="true" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500" />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Blog Image (optional)</label>
                                <div class="space-y-2">
                                    <div>
                                        <label for="imageFile" class="block text-xs text-gray-600">Upload File</label>
                                        <input
                                            type="file"
                                            id="imageFile"
                                            accept="image/*"
                                            class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100"
                                        />
                                    </div>
                                    <div class="text-center text-xs text-gray-500">OR</div>
                                    <div>
                                        <label for="imageUrl" class="block text-xs text-gray-600">Image URL</label>
                                        <input
                                            id="imageUrl"
                                            type="url"
                                            placeholder="https://example.com/image.jpg"
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 text-sm"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="content" class="block text-sm font-medium text-gray-700">Content</label>
                                <textarea id="content" name="content" rows="6" required aria-required="true" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
                            </div>

                            <div>
                                <label for="isPublished" class="block text-sm font-medium text-gray-700">Published Status</label>
                                <select id="isPublished" name="isPublished" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                    <option value="true" selected>Published</option>
                                    <option value="false">Draft</option>
                                </select>
                            </div>

                            <div class="flex space-x-2">
                                <button type="submit" id="submitBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">Create Blog</button>
                                <button type="button" id="cancelEditBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none hidden">Cancel</button>
                            </div>

                            <p id="formMessage" class="mt-2 text-red-600 font-medium" role="alert"></p>
                        </form>
                    </div>
                </div>

                <!-- Blogs Table -->
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">All Blogs</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" aria-describedby="blogsTableCaption">
                            <caption id="blogsTableCaption" class="sr-only">List of blogs with title, content preview, status, creation date, and actions</caption>
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Content</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blogsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="px-6 py-4">
                        <p id="loadingMessage" class="text-gray-500" aria-live="polite">Loading blogs...</p>
                        <p id="errorMessage" class="mt-2 text-red-600 font-semibold" role="alert"></p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="bg-white rounded-xl shadow-lg max-w-xl w-full p-6 space-y-4" tabindex="-1">
            <h2 id="editModalTitle" class="text-xl font-semibold text-blue-600">Edit Blog</h2>
            <input type="hidden" id="modalBlogId" />
            <div>
                <label for="modalTitle" class="block text-gray-700 font-medium mb-1">Title</label>
                <input id="modalTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
            </div>
            <div>
                <label for="modalContent" class="block text-gray-700 font-medium mb-1">Content</label>
                <textarea id="modalContent" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="4"></textarea>
            </div>
            <div>
                <label for="modalIsPublished" class="block text-gray-700 font-medium mb-1">Status</label>
                <select id="modalIsPublished" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="true">Published</option>
                    <option value="false">Draft</option>
                </select>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="closeModalBtn" class="px-4 py-2 rounded-md bg-gray-500 text-white hover:bg-gray-600">Cancel</button>
                <button id="saveModalBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <script>
      const apiUrl = "/api/blogs";

      // Upload image to Cloudinary
      async function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('folder', 'ecommerce/blogs');
        
        try {
          const response = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          if (result.success) {
            return result.url;
          } else {
            throw new Error(result.error || 'Upload failed');
          }
        } catch (error) {
          console.error('Upload error:', error);
          throw error;
        }
      }

      function escapeHTML(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatDate(isoString) {
        const d = new Date(isoString);
        return d.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      const loadingMessage = document.getElementById("loadingMessage");
      const errorMessage = document.getElementById("errorMessage");
      const formMessage = document.getElementById("formMessage");

      async function loadBlogs() {
        loadingMessage.style.display = "block";
        errorMessage.textContent = "";
        const tbody = document.getElementById("blogsTableBody");
        tbody.innerHTML = "";
        try {
          const res = await fetch(apiUrl);
          if (!res.ok) throw new Error("Failed to fetch blogs");
          const blogs = await res.json();
          if (blogs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No blogs found.</td></tr>`;
          } else {
            blogs.forEach((blog) => {
              tbody.insertAdjacentHTML(
                "beforeend",
                `<tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${blog.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" title="${escapeHTML(blog.title)}">${escapeHTML(blog.title)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" title="${escapeHTML(blog.content)}">${escapeHTML(blog.content)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${blog.is_published ? "text-green-600" : "text-gray-400"}">${blog.is_published ? "Published" : "Draft"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(blog.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <button class="editBtn bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" data-id="${blog.id}" aria-label="Edit blog titled ${escapeHTML(blog.title)}">Edit</button>
                  <button class="deleteBtn bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" data-id="${blog.id}" aria-label="Delete blog titled ${escapeHTML(blog.title)}">Delete</button>
                </td>
              </tr>`
              );
            });
          }
        } catch (e) {
          errorMessage.textContent = e.message;
        } finally {
          loadingMessage.style.display = "none";
        }
      }

      function resetForm() {
        document.getElementById("blogForm").reset();
        document.getElementById("blogId").value = "";
        document.getElementById("formTitle").textContent = "Create New Blog";
        document.getElementById("submitBtn").textContent = "Create Blog";
        document.getElementById("cancelEditBtn").classList.add("hidden");
        formMessage.textContent = "";
      }

      function fillFormForEdit(blog) {
        document.getElementById("blogId").value = blog.id;
        document.getElementById("title").value = blog.title;
        document.getElementById("imageUrl").value = blog.image_url || "";
        document.getElementById("content").value = blog.content;
        document.getElementById("isPublished").value = blog.is_published ? "true" : "false";
        document.getElementById("formTitle").textContent = "Edit Blog";
        document.getElementById("submitBtn").textContent = "Update Blog";
        document.getElementById("cancelEditBtn").classList.remove("hidden");
        formMessage.textContent = "";
      }

      async function createBlog(blogData) {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(blogData),
        });
        if (!res.ok) {
          const error = await res.text();
          throw new Error("Create failed: " + error);
        }
        return await res.json();
      }

      async function updateBlog(id, blogData) {
        const res = await fetch(`${apiUrl}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(blogData),
        });
        if (!res.ok) {
          const error = await res.text();
          throw new Error("Update failed: " + error);
        }
        return await res.json();
      }

      async function deleteBlog(id) {
        const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
        if (!res.ok) {
          const error = await res.text();
          throw new Error("Delete failed: " + error);
        }
      }

      document.getElementById("blogForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        formMessage.textContent = "";
        const id = document.getElementById("blogId").value;
        
        try {
          // Handle image upload
          let imageUrl = document.getElementById("imageUrl").value.trim();
          const imageFile = document.getElementById("imageFile").files[0];
          
          if (imageFile) {
            formMessage.textContent = "Uploading image...";
            formMessage.className = "mt-2 text-primary-600 font-medium";
            imageUrl = await uploadImage(imageFile);
          }
          
          const blogData = {
            title: document.getElementById("title").value.trim(),
            image_url: imageUrl,
            content: document.getElementById("content").value.trim(),
            is_published: document.getElementById("isPublished").value === "true",
          };
          
          if (!blogData.title || !blogData.content) {
            formMessage.textContent = "Title and Content are required.";
            formMessage.className = "mt-2 text-red-600 font-medium";
            return;
          }
          
          formMessage.textContent = id ? "Updating blog..." : "Creating blog...";
          formMessage.className = "mt-2 text-primary-600 font-medium";
          
          if (id) {
            await updateBlog(id, blogData);
            formMessage.textContent = "Blog updated successfully.";
          } else {
            await createBlog(blogData);
            formMessage.textContent = "Blog created successfully.";
          }
          formMessage.className = "mt-2 text-green-600 font-medium";
          resetForm();
          loadBlogs();
        } catch (error) {
          formMessage.textContent = error.message;
          formMessage.className = "mt-2 text-red-600 font-medium";
        }
      });

      document.getElementById("cancelEditBtn").addEventListener("click", () => {
        resetForm();
      });

      document.getElementById("blogsTableBody").addEventListener("click", async (e) => {
        if (e.target.classList.contains("editBtn")) {
          const id = e.target.dataset.id;
          try {
            const res = await fetch(`${apiUrl}/${id}`);
            if (!res.ok) throw new Error("Failed to fetch blog details");
            const blog = await res.json();
            fillFormForEdit(blog);
            window.scrollTo({ top: 0, behavior: "smooth" });
          } catch (error) {
            errorMessage.textContent = error.message;
          }
        } else if (e.target.classList.contains("deleteBtn")) {
          const id = e.target.dataset.id;
          if (confirm("Are you sure you want to delete this blog? This action cannot be undone.")) {
            try {
              await deleteBlog(id);
              loadBlogs();
            } catch (error) {
              errorMessage.textContent = error.message;
            }
          }
        }
      });

      const editModal = document.getElementById("editModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const saveModalBtn = document.getElementById("saveModalBtn");

      function openModal() { editModal.classList.remove("hidden"); }
      function closeModal() { editModal.classList.add("hidden"); }
      closeModalBtn?.addEventListener("click", closeModal);

      saveModalBtn?.addEventListener("click", async () => {
        const id = document.getElementById("modalBlogId").value;
        const updatedData = {
          title: document.getElementById("modalTitle").value.trim(),
          content: document.getElementById("modalContent").value.trim(),
          is_published: document.getElementById("modalIsPublished").value === "true",
        };
        if (!updatedData.title || !updatedData.content) {
          alert("Title and Content cannot be empty.");
          return;
        }
        try {
          await updateBlog(id, updatedData);
          closeModal();
          loadBlogs();
        } catch (error) {
          alert("Error saving blog: " + error.message);
        }
      });

      loadBlogs();
    </script>
  </body>
</html>
