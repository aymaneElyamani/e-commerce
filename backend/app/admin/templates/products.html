<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gradient-to-br from-gray-100 to-indigo-50 min-h-screen p-6 flex flex-col items-center"
  >
    <div class="max-w-6xl w-full bg-white/90 p-8 rounded-2xl shadow-xl">
      <div class="flex justify-between items-center mb-6">
        <a
          href="/admin"
          class="bg-blue-500 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg shadow transition"
        >
          ‚Üê Back to dashboard
        </a>
      </div>
      <h1
        class="text-4xl font-extrabold mb-10 text-center text-indigo-700 tracking-tight drop-shadow"
      >
        Product Admin Panel
      </h1>

      <!-- Create Product Form -->
      <section class="mb-12 max-w-lg mx-auto">
        <h2
          class="text-2xl font-semibold mb-5 text-indigo-600 border-b-2 border-indigo-200 pb-2"
        >
          Create New Product
        </h2>
        <form id="createProductForm" class="space-y-4">
          <input
            name="name"
            placeholder="Name"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <input
            name="description"
            placeholder="Description"
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <input
            name="price"
            type="number"
            step="0.01"
            placeholder="Price"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <input
            name="image_cover"
            placeholder="Image URL"
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />

          <textarea
            name="image_details"
            placeholder='Image Details (JSON array, e.g. ["url1","url2"])'
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
            rows="3"
          ></textarea>

          <input
            name="quantity"
            type="number"
            placeholder="Quantity"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <select
            name="category"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          >
            <option value="" disabled selected>Select a category</option>
            <option value="man">Man</option>
            <option value="women">Women</option>
            <option value="kids">Kids</option>
          </select>

          <button
            type="submit"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow"
          >
            Create Product
          </button>
        </form>
        <div id="createStatus" class="mt-3 text-center text-sm"></div>
      </section>

      <!-- Product List Table -->
      <section>
        <h2
          class="text-2xl font-semibold mb-5 text-indigo-600 border-b-2 border-indigo-200 pb-2"
        >
          Product List
        </h2>
        <div
          class="overflow-x-auto rounded-2xl shadow border border-indigo-100 bg-white/90"
        >
          <table class="min-w-full">
            <thead class="bg-indigo-50">
              <tr>
                <th
                  class="py-3 px-6 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider"
                >
                  ID
                </th>
                <th
                  class="py-3 px-6 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider"
                >
                  Name
                </th>
                <th
                  class="py-3 px-6 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider"
                >
                  Price
                </th>
                <th
                  class="py-3 px-6 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="productsTableBody" class="divide-y divide-indigo-50">
              <!-- Products will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="loading" class="mt-6 text-center text-gray-600">
          Loading products...
        </div>
        <div id="error" class="mt-6 text-center text-red-600 hidden"></div>
      </section>
    </div>

    <!-- Edit Product Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div
        class="bg-white rounded-2xl max-w-md w-full p-6 relative shadow-xl border border-indigo-100"
      >
        <button
          id="closeEditModal"
          class="absolute top-3 right-3 text-gray-600 hover:text-gray-900 font-bold text-2xl"
        >
          &times;
        </button>
        <h3 class="text-2xl font-semibold mb-4 text-indigo-700">
          Edit Product
        </h3>
        <form id="editProductForm" class="space-y-4">
          <input name="id" type="hidden" />
          <input
            name="name"
            placeholder="Name"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <input
            name="description"
            placeholder="Description"
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <input
            name="price"
            type="number"
            step="0.01"
            placeholder="Price"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <input
            name="image_cover"
            placeholder="Image URL"
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />

          <textarea
            name="image_details"
            placeholder='Image Details (JSON array, e.g. ["url1","url2"])'
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
            rows="3"
          ></textarea>

          <input
            name="quantity"
            type="number"
            placeholder="Quantity"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          />
          <select
            name="category"
            required
            class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-indigo-50"
          >
            <option value="" disabled>Select a category</option>
            <option value="man">Man</option>
            <option value="women">Women</option>
            <option value="kids">Kids</option>
          </select>

          <button
            type="submit"
            class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-3 rounded-lg transition duration-200 shadow"
          >
            Update Product
          </button>
        </form>
        <div id="editStatus" class="mt-3 text-center text-sm"></div>
      </div>
    </div>

    <script>
      const apiBase = "/api/products";

      async function fetchProducts() {
        const loadingEl = document.getElementById("loading");
        const errorEl = document.getElementById("error");
        const tbody = document.getElementById("productsTableBody");
        loadingEl.style.display = "block";
        errorEl.classList.add("hidden");
        tbody.innerHTML = "";

        try {
          const res = await fetch(apiBase);
          if (!res.ok) throw new Error("Failed to fetch products");
          const products = await res.json();

          if (products.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No products found.</td></tr>`;
            loadingEl.style.display = "none";
            return;
          }

          for (const product of products) {
            const tr = document.createElement("tr");
            tr.classList.add("hover:bg-gray-50");
            tr.innerHTML = `
            <td class="py-3 px-6">${product.id}</td>
            <td class="py-3 px-6 font-medium text-gray-800">${product.name}</td>
            <td class="py-3 px-6 text-indigo-700 font-semibold">$${Number(
              product.price
            ).toFixed(2)}</td>
            <td class="py-3 px-6 text-center space-x-2">
              <button onclick="openEditModal(${product.id})" 
                class="px-3 py-1 bg-yellow-400 hover:bg-yellow-500 rounded-md text-white font-semibold transition">
                Edit
              </button>
              <button onclick="deleteProduct(${product.id})"
                class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded-md text-white font-semibold transition">
                Delete
              </button>
            </td>
          `;
            tbody.appendChild(tr);
          }
        } catch (err) {
          errorEl.textContent = err.message;
          errorEl.classList.remove("hidden");
        } finally {
          loadingEl.style.display = "none";
        }
      }

      async function createProduct(event) {
        event.preventDefault();
        const form = event.target;
        const status = document.getElementById("createStatus");

        // Collect form data
        const data = {
          name: form.name.value.trim(),
          description: form.description.value.trim(),
          price: parseFloat(form.price.value),
          image_cover: form.image_cover.value.trim(),
          quantity: parseInt(form.quantity.value, 10),
          category: form.category.value,
        };

        // Parse image_details JSON, fallback to empty array
        try {
          data.image_details = form.image_details.value
            ? JSON.parse(form.image_details.value)
            : [];
          if (!Array.isArray(data.image_details)) throw new Error();
        } catch {
          status.textContent = "Image Details must be a valid JSON array.";
          status.className = "text-red-600 mt-2";
          return;
        }

        status.textContent = "Creating product...";
        status.className = "text-indigo-600 mt-2";

        try {
          const res = await fetch(apiBase, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          if (!res.ok) throw new Error("Failed to create product");
          status.textContent = "Product created successfully!";
          status.className = "text-green-600 mt-2";
          form.reset();
          fetchProducts();
        } catch (err) {
          status.textContent = err.message;
          status.className = "text-red-600 mt-2";
        }
      }

      // Edit modal logic
      const editModal = document.getElementById("editModal");
      const editForm = document.getElementById("editProductForm");
      const editStatus = document.getElementById("editStatus");

      function openEditModal(productId) {
        // Fetch single product data (or get from cached)
        fetch(`${apiBase}/${productId}`)
          .then((res) => {
            if (!res.ok) throw new Error("Failed to fetch product details");
            return res.json();
          })
          .then((product) => {
            // Fill form inputs
            editForm.id.value = product.id;
            editForm.name.value = product.name;
            editForm.description.value = product.description || "";
            editForm.price.value = product.price;
            editForm.image_cover.value = product.image_cover || "";
            editForm.quantity.value = product.quantity;
            editForm.category.value = product.category || "";
            editForm.image_details.value = product.image_details
              ? JSON.stringify(product.image_details, null, 2)
              : "[]";

            editStatus.textContent = "";
            editModal.classList.remove("hidden");
          })
          .catch((err) => {
            alert(err.message);
          });
      }

      document.getElementById("closeEditModal").onclick = () => {
        editModal.classList.add("hidden");
        editStatus.textContent = "";
      };

      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
          id: editForm.id.value,
          name: editForm.name.value.trim(),
          description: editForm.description.value.trim(),
          price: parseFloat(editForm.price.value),
          image_cover: editForm.image_cover.value.trim(),
          quantity: parseInt(editForm.quantity.value, 10),
          category: editForm.category.value,
        };

        try {
          data.image_details = editForm.image_details.value
            ? JSON.parse(editForm.image_details.value)
            : [];
          if (!Array.isArray(data.image_details)) throw new Error();
        } catch {
          editStatus.textContent = "Image Details must be a valid JSON array.";
          editStatus.className = "text-red-600 mt-2";
          return;
        }

        editStatus.textContent = "Updating product...";
        editStatus.className = "text-indigo-600 mt-2";

        try {
          const res = await fetch(`${apiBase}/${data.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          if (!res.ok) throw new Error("Failed to update product");
          editStatus.textContent = "Product updated successfully!";
          editStatus.className = "text-green-600 mt-2";

          fetchProducts();

          setTimeout(() => {
            editModal.classList.add("hidden");
            editStatus.textContent = "";
          }, 1500);
        } catch (err) {
          editStatus.textContent = err.message;
          editStatus.className = "text-red-600 mt-2";
        }
      });

      async function deleteProduct(productId) {
        if (!confirm("Are you sure you want to delete this product?")) return;
        try {
          const res = await fetch(`${apiBase}/${productId}`, {
            method: "DELETE",
          });
          if (!res.ok) throw new Error("Failed to delete product");
          fetchProducts();
        } catch (err) {
          alert(err.message);
        }
      }

      document
        .getElementById("createProductForm")
        .addEventListener("submit", createProduct);

      // Load products on page load
      fetchProducts();
    </script>
  </body>
</html>
