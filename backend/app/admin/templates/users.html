<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2>User Management</h2>

  <!-- Create Form -->
  <form id="createForm" class="row g-3 mb-4">
    <div class="col-md-5">
      <input type="email" class="form-control" id="createEmail" placeholder="Email" required />
    </div>
    <div class="col-md-5">
      <input type="password" class="form-control" id="createPassword" placeholder="Password" required />
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Add User</button>
    </div>
  </form>

  <!-- User Table -->
  <table class="table table-bordered table-striped bg-white">
    <thead>
      <tr>
        <th>ID</th>
        <th>Email</th>
        <th style="width: 150px;">Actions</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editUserId" />
        <div class="mb-3">
          <label for="editEmail" class="form-label">Email</label>
          <input type="email" class="form-control" id="editEmail" required />
        </div>
        <div class="mb-3">
          <label for="editPassword" class="form-label">New Password (optional)</label>
          <input type="password" class="form-control" id="editPassword" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Update</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const apiUrl = "/api/auth/users";

  async function fetchUsers() {
    const res = await fetch(apiUrl);
    const users = await res.json();
    const tbody = document.getElementById("userTable");
    tbody.innerHTML = users.map(user => `
      <tr>
        <td>${user.id}</td>
        <td>${user.email}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id}, '${user.email}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
        </td>
      </tr>
    `).join("");
  }

  document.getElementById("createForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("createEmail").value;
    const password = document.getElementById("createPassword").value;

    const res = await fetch("/api/auth/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    const result = await res.json();
    alert(result.message || result.error);
    e.target.reset();
    fetchUsers();
  });

  function openEditModal(id, email) {
    document.getElementById("editUserId").value = id;
    document.getElementById("editEmail").value = email;
    document.getElementById("editPassword").value = "";
    const modal = new bootstrap.Modal(document.getElementById("editUserModal"));
    modal.show();
  }

  document.getElementById("editForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("editUserId").value;
    const email = document.getElementById("editEmail").value;
    const password = document.getElementById("editPassword").value;

    const payload = { email };
    if (password) payload.password = password;

    const res = await fetch(`${apiUrl}/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const result = await res.json();
    alert(result.message || result.error);
    bootstrap.Modal.getInstance(document.getElementById("editUserModal")).hide();
    fetchUsers();
  });

  async function deleteUser(id) {
    if (!confirm("Are you sure?")) return;
    const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
    const result = await res.json();
    alert(result.message || result.error);
    fetchUsers();
  }

  fetchUsers();
</script>
</body>
</html>
